name: Update Law Data

on:
  schedule:
    # æ¯æ—¥åˆå‰8æ™‚ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰ã«å®Ÿè¡Œ
    # UTCã§23æ™‚ = JST 8æ™‚ï¼ˆ+9æ™‚é–“ï¼‰
    - cron: '0 23 * * *'
  
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  
  push:
    branches:
      - main
    paths:
      - 'scraper.py'  # ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ‘ãƒ¼ãŒæ›´æ–°ã•ã‚ŒãŸæ™‚ã‚‚å®Ÿè¡Œ

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install beautifulsoup4==4.12.2 requests==2.31.0 lxml==4.9.3
    
    - name: Create data directory
      run: |
        mkdir -p public/data
    
    - name: Run scraper
      run: |
        echo "ãƒ‡ãƒ¼ã‚¿åé›†é–‹å§‹: $(date)"
        python scraper.py
        
        # JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ public/data/ ã«ç§»å‹•
        if [ -f "revisions_list.json" ]; then
          mv revisions_list.json public/data/revisions.json
          echo "âœ… ãƒ‡ãƒ¼ã‚¿åé›†æˆåŠŸ"
        else
          echo "âŒ ã‚¨ãƒ©ãƒ¼: revisions_list.json ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          exit 1
        fi
    
    - name: Check if data changed
      id: check_changes
      run: |
        git diff --quiet public/data/revisions.json || echo "changed=true" >> $GITHUB_OUTPUT
    
    - name: Commit and push if changed
      if: steps.check_changes.outputs.changed == 'true'
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add public/data/revisions.json
        git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–°: æ³•ä»¤æ”¹æ­£ãƒ‡ãƒ¼ã‚¿ $(date +'%Y-%m-%d %H:%M')"
        git push
    
    - name: No changes detected
      if: steps.check_changes.outputs.changed != 'true'
      run: |
        echo "â„¹ï¸ ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
    
    - name: Upload artifact (for debugging)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: law-data
        path: public/data/revisions.json
        retention-days: 7
