name: Update Law Data

permissions:
  contents: write

on:
  schedule:
    # æ¯æ—¥åˆå‰8æ™‚ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰ã«å®Ÿè¡Œ
    # UTCã§23æ™‚ = JST 8æ™‚ï¼ˆ+9æ™‚é–“ï¼‰
    - cron: "0 23 * * *"

  workflow_dispatch: {}

  push:
    branches:
      - main
    paths:
      - "scraper.py" # ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ‘ãƒ¼ãŒæ›´æ–°ã•ã‚ŒãŸæ™‚ã‚‚å®Ÿè¡Œ

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install beautifulsoup4==4.12.2 requests==2.31.0 lxml==4.9.3

      - name: Create data directory
        run: |
          mkdir -p public/data

      - name: Run scraper
        run: |
          echo "=== ãƒ‡ãƒ¼ã‚¿åé›†é–‹å§‹: $(date -u) UTC ==="
          python scraper.py

          if [ -f "public/data/revisions.json" ]; then
            echo "âœ… ç”ŸæˆOK: public/data/revisions.json"
          else
            echo "âŒ ã‚¨ãƒ©ãƒ¼: public/data/revisions.json ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi

      - name: Check if data changed
        id: check_changes
        run: |
          # æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«(untracked)ã‚‚å«ã‚ã¦å¤‰æ›´ã‚’æ¤œçŸ¥ã™ã‚‹
          if [ -n "$(git status --porcelain public/data/revisions.json)" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "âœ… changed=true"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "â„¹ï¸ changed=false"
          fi

      - name: Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add public/data/revisions.json
          git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–°: æ³•ä»¤æ”¹æ­£ãƒ‡ãƒ¼ã‚¿ $(date -u +'%Y-%m-%d %H:%M') UTC" || exit 0
          git push

      - name: No changes detected
        if: steps.check_changes.outputs.changed != 'true'
        run: |
          echo "â„¹ï¸ ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"

      - name: Upload artifact (for debugging)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: law-data
          path: public/data/revisions.json
          retention-days: 7
